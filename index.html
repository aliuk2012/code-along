<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>code-along</title>

    <script src="codemirror/codemirror-compressed.js"></script>
    <link rel="stylesheet" href="codemirror/codemirror.css">

    <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet">
    <script type="text/javascript">
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('font-sw.js')
      .catch(function(e){console.log(e)})
    }
    </script>

    <style media="screen">
      body {margin:0;height: 100vh; display: flex}
      iframe, #code {margin:0;display: block; width: 100%; flex: 1}
      textarea {font-family: monospace; font-size: 1.25em; border:none}
      iframe {border: none;}
      #code {
        box-shadow: rgba(0,0,0,.2) 0 0 15px;
      }

      #code {
        padding: 1em;
        position: relative;
      }

      /* this should be a toggle element */
      #code:before {
        content:'â€¹';
        line-height: 0.8em;
        font-family: 'Inconsolata', monospace;
        font-size: 3em;
        position: absolute;
        left:-1.25em;
        background: #fff;
        border-radius: 100%;
        width: 1em;
        height:1em;
        text-align: center;
        box-shadow: rgba(0,0,0,.2) 0 0 15px;
        transform: rotate(180deg);
        transition: .2s transform;
        cursor: pointer;
      }
      .CodeMirror {
        height: 100%;
        font-family: 'Inconsolata', monospace;
      }
      .CodeMirror .error-widget {
        margin-top: -1.05em;
        width: .5em;
        background: rgba(255, 0, 0, .5);
      }
    </style>
  </head>
  <body>
    <iframe src="about:blank"></iframe>
    <div id="code"></div>


    <script type="text/javascript">
      var code = CodeMirror(document.getElementById('code'), {
        value: "document.body.style.background = '#08f'",
        mode:  "javascript"
      })

      var textarea = document.querySelector('textarea')
      var iframe   = document.querySelector('iframe')

      var template = fetch('template.txt')
                       .then(r => r.text())

      function load(){
        template
          .then(text => {

            URL.revokeObjectURL(iframe.src)

            var blob = new Blob([text
              .split('{{INJECT}}')
              .join(code.getValue())], {type: 'text/html'})

            var url = URL.createObjectURL(blob)
            iframe.src = url
          })

      }

      load()
      code.on('change', load)

      var steps = []
      //
      // fetch('/data/_meta.json')
      //   .then(res => res.json())
      //   .then(items => {
      //     var requests = items.map(s => fetch(s.path).then(res => res.text()))
      //     Promise.all(requests)
      //       .then(_steps => {
      //         steps = _steps
      //         steps.forEach((s) => {
      //           var li = document.createElement('li')
      //           li.innerText = s
      //           document.getElementById('history').appendChild(li)
      //         })
      //       })
      //     // console.log(items)
      //   })


    </script>
  </body>
</html>
